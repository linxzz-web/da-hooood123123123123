-- CONFIGURATION - EDIT THESE VALUES
local TARGET_USERNAME = "zdenda3030" -- The target player's username
local RISE_SPEED = 2 -- How fast to rise (studs per second)
local UNDER_OFFSET = 3 -- How many studs below the target to stay
local ITEM_NAME = "[WALLET]" -- The item name to check for
local CHECK_FREQUENCY = 0.5 -- How often to check inventory (seconds)

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")

-- Variables
local isRising = false
local targetPlayer = nil
local heartbeatConnection = nil
local lastInventoryState = nil -- Track last state to detect changes

-- Wait for LocalPlayer
repeat task.wait() until LocalPlayer and LocalPlayer.Character

-- Function to find target player
local function findTargetPlayer()
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Name:lower() == TARGET_USERNAME:lower() then
            return player
        end
    end
    return nil
end

-- DEBUG FUNCTION: Print all inventory items
local function debugInventory()
    print("\n=== INVENTORY DEBUG ===")
    
    -- Check Backpack
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if backpack then
        print("Backpack items (" .. #backpack:GetChildren() .. "):")
        for _, item in ipairs(backpack:GetChildren()) do
            print("  - \"" .. item.Name .. "\" (" .. item.ClassName .. ")")
        end
    else
        print("No Backpack found")
    end
    
    -- Check Character for equipped items
    if LocalPlayer.Character then
        local equipped = {}
        for _, item in ipairs(LocalPlayer.Character:GetChildren()) do
            if item:IsA("Tool") or item:IsA("Accessory") or item:IsA("HopperBin") then
                table.insert(equipped, "  - \"" .. item.Name .. "\" (" .. item.ClassName .. ")")
            end
        end
        if #equipped > 0 then
            print("Equipped items:")
            for _, line in ipairs(equipped) do
                print(line)
            end
        else
            print("No equipped items")
        end
    end
    
    print("========================\n")
end

-- IMPROVED: Check if wallet is in inventory
local function hasItem(itemName)
    -- Check Backpack
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if backpack then
        for _, item in ipairs(backpack:GetChildren()) do
            -- Case-insensitive comparison
            if string.lower(item.Name) == string.lower(itemName) or 
               string.find(string.lower(item.Name), string.lower(itemName)) then
                print("‚úÖ FOUND in Backpack: \"" .. item.Name .. "\"")
                return true
            end
        end
    end
    
    -- Check Character for equipped items
    if LocalPlayer.Character then
        for _, item in ipairs(LocalPlayer.Character:GetChildren()) do
            if item:IsA("Tool") or item:IsA("HopperBin") then
                if string.lower(item.Name) == string.lower(itemName) or 
                   string.find(string.lower(item.Name), string.lower(itemName)) then
                    print("‚úÖ FOUND equipped: \"" .. item.Name .. "\"")
                    return true
                end
            end
        end
    end
    
    return false
end

-- Function to smoothly move player under target
local function moveUnderTarget()
    if not targetPlayer or not targetPlayer.Character then return end
    if not LocalPlayer.Character then return end
    
    local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart") or targetPlayer.Character:FindFirstChild("Torso")
    local localRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart") or LocalPlayer.Character:FindFirstChild("Torso")
    
    if not targetRoot or not localRoot then return end
    
    -- Calculate target position (below target)
    local targetPosition = Vector3.new(
        targetRoot.Position.X,
        targetRoot.Position.Y - UNDER_OFFSET,
        targetRoot.Position.Z
    )
    
    -- Smoothly move up
    local currentPos = localRoot.Position
    local newY = currentPos.Y + (RISE_SPEED * 0.1)
    
    -- Don't go past target height
    if newY > targetPosition.Y then
        newY = targetPosition.Y
    end
    
    -- Apply movement
    localRoot.CFrame = CFrame.new(currentPos.X, newY, currentPos.Z)
end

-- Function to START rising (when NO wallet)
local function startRising()
    if isRising then 
        print("‚ö†Ô∏è Already rising")
        return
    end
    
    targetPlayer = findTargetPlayer()
    if not targetPlayer then
        print("‚ùå Target player '" .. TARGET_USERNAME .. "' not found!")
        return
    end
    
    if not LocalPlayer.Character then
        print("‚ùå Local player has no character!")
        return
    end
    
    print("üîº STARTING to rise - NO " .. ITEM_NAME .. " in inventory!")
    isRising = true
    
    if heartbeatConnection then
        heartbeatConnection:Disconnect()
    end
    
    heartbeatConnection = RunService.Heartbeat:Connect(function()
        if isRising and targetPlayer and targetPlayer.Character and LocalPlayer.Character then
            moveUnderTarget()
        end
    end)
end

-- Function to STOP rising (when HAS wallet)
local function stopRising()
    if not isRising then 
        print("‚ö†Ô∏è Already stopped")
        return
    end
    
    print("üîΩ STOPPING rise - " .. ITEM_NAME .. " found in inventory!")
    isRising = false
    
    if heartbeatConnection then
        heartbeatConnection:Disconnect()
        heartbeatConnection = nil
    end
end

-- Check inventory and update state
local function checkInventoryAndUpdate()
    local hasWallet = hasItem(ITEM_NAME)
    
    -- Only act if state changed
    if hasWallet ~= lastInventoryState then
        if hasWallet then
            print("üì¶ Inventory CHANGED: Wallet APPEARED")
            stopRising()
        else
            print("üì¶ Inventory CHANGED: Wallet DISAPPEARED")
            startRising()
        end
        lastInventoryState = hasWallet
    end
    
    -- Print current status occasionally
    if tick() % 3 < 0.1 then
        local status = hasWallet and "HAS üî¥" or "NO üü¢"
        print("üìä Status: " .. status .. " " .. ITEM_NAME .. " | Rising: " .. (isRising and "YES üîº" or "NO üîΩ"))
    end
end

-- Main execution
spawn(function()
    print("\nüöÄ === UNDER SCRIPT LOADED ===")
    print("Target: " .. TARGET_USERNAME)
    print("Item to check: \"" .. ITEM_NAME .. "\"")
    print("Logic: Rise when NO wallet, Stop when HAVE wallet")
    print("================================\n")
    
    -- Find target initially
    targetPlayer = findTargetPlayer()
    if targetPlayer then
        print("‚úÖ Target player found: " .. targetPlayer.Name)
    else
        print("‚ö†Ô∏è Target player not found yet - will check periodically")
    end
    
    -- Initial inventory debug
    task.wait(1)
    debugInventory()
    
    -- Initial inventory check
    lastInventoryState = hasItem(ITEM_NAME)
    print("Initial inventory state: " .. (lastInventoryState and "HAS wallet üî¥" or "NO wallet üü¢"))
    
    if not lastInventoryState then
        print("üü¢ No wallet detected - starting rise...")
        startRising()
    else
        print("üî¥ Wallet detected - waiting for removal...")
    end
    
    -- Main monitoring loop
    while true do
        checkInventoryAndUpdate()
        task.wait(CHECK_FREQUENCY)
    end
end)

-- Manual controls
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.I then
        -- Press I to debug inventory
        debugInventory()
        print("Current wallet status: " .. (hasItem(ITEM_NAME) and "HAS üî¥" or "NO üü¢"))
    elseif input.KeyCode == Enum.KeyCode.R then
        -- Press R to manually start rising
        print("üñêÔ∏è Manual: Starting rise")
        startRising()
    elseif input.KeyCode == Enum.KeyCode.S then
        -- Press S to manually stop rising
        print("üñêÔ∏è Manual: Stopping rise")
        stopRising()
    elseif input.KeyCode == Enum.KeyCode.T then
        -- Press T to toggle
        if isRising then
            stopRising()
        else
            startRising()
        end
    end
end)

print("\nüéÆ CONTROLS:")
print("  I - Debug inventory")
print("  R - Manually start rising")
print("  S - Manually stop rising")
print("  T - Toggle rising on/off")
print("====================\n")
